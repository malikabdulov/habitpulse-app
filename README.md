# HabitPulse

HabitPulse — полнофункциональная система отслеживания привычек, включающая бэкенд на FastAPI, мобильное приложение на Flutter, базу данных PostgreSQL и мониторинг с использованием Prometheus и Grafana. Проект полностью готов для локального запуска через Docker Compose и содержит инструменты тестирования как для бэкенда, так и для мобильного клиента.

## Структура проекта

```
habitpulse-app/
├── backend/            # Исходный код FastAPI, миграции Alembic и тесты
├── mobile/             # Мобильное приложение Flutter
├── prometheus/         # Конфигурация Prometheus
├── grafana/            # Экспортированный дашборд Grafana
├── docker-compose.yml  # Определение всех контейнеров
└── .env.example        # Пример файла переменных окружения
```

## Предварительные требования

Перед началом убедитесь, что установлены:

- Docker и Docker Compose
- Flutter SDK (для запуска мобильного клиента)
- Make (опционально, но удобно для группировки команд)

## Настройка переменных окружения

1. Создайте файл `.env` из примера и при необходимости отредактируйте значения:
   ```bash
   cp .env.example .env
   ```
2. Проверьте переменные подключения к базе данных в `.env`:
   - `POSTGRES_USER`
   - `POSTGRES_PASSWORD`
   - `POSTGRES_DB`
   - `DATABASE_URL`

## Запуск инфраструктуры

1. Соберите и запустите все сервисы:
   ```bash
   docker compose up -d --build
   ```
2. Убедитесь, что контейнеры работают:
   ```bash
   docker compose ps
   ```
3. Примените миграции базы данных внутри контейнера `backend`:
   ```bash
   docker exec -it habitpulse-app-backend alembic upgrade head
   ```
4. Проверьте доступность основных сервисов:
   - Swagger UI с документацией API: http://localhost:8000/docs
   - Prometheus: http://localhost:9090
   - Grafana (логин/пароль по умолчанию `admin/admin`): http://localhost:3000

## Запуск мобильного приложения Flutter

1. Перейдите в директорию проекта Flutter:
   ```bash
   cd mobile/habitpulse
   ```
2. Установите зависимости:
   ```bash
   flutter pub get
   ```
3. Запустите приложение, передав базовый URL API (для эмулятора Android используйте `10.0.2.2`):
   ```bash
   flutter run --dart-define=HABITPULSE_API_BASE_URL=http://10.0.2.2:8000
   ```
   Для реального устройства или iOS-симулятора укажите соответствующий хост, например `http://localhost:8000` при использовании прокси/туннеля.

## Тестирование

### Тесты бэкенда

1. Перейдите в директорию `backend`:
   ```bash
   cd backend
   ```
2. Запустите тесты Pytest:
   ```bash
   pytest
   ```
   При необходимости используйте переменные окружения для указания тестовой базы данных.

### Тесты мобильного приложения

1. Перейдите в директорию Flutter-проекта:
   ```bash
   cd mobile/habitpulse
   ```
2. Выполните виджет-тесты:
   ```bash
   flutter test
   ```

## Мониторинг и аналитика

- Бэкенд автоматически экспортирует метрики по адресу `http://localhost:8000/metrics`.
- Prometheus собирает данные каждые 5 секунд согласно `prometheus/prometheus.yml`.
- Импортированный дашборд Grafana (`grafana/dashboard.json`) отображает:
  - количество запросов к API;
  - среднюю задержку ответов;
  - количество ошибок;
  - общее число привычек в базе.

## Дополнительные рекомендации

- Миграции Alembic размещены в `backend/alembic/versions`. Добавляйте новые миграции при изменении схемы базы данных.
- Для разработки без Docker можно запустить FastAPI локально, установив зависимости из `backend/requirements.txt` и указав корректный `DATABASE_URL`.
- Перед развертыванием в продакшн измените стандартные учетные данные Grafana и пароли базы данных.

Удачной работы с HabitPulse!
